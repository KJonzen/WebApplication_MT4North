<!--<p class=" text-black mt-2 mb-3">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. </p>-->
<div *ngIf="isDataLoaded">

  <div class="row ml-0 mt-4 mb-2">

    <div class="col m-0 p-0  d-none d-md-inline im-toolbar mr-4">
      <div class="mr-4 btn-group btn-group-sm d-flex" role="group" aria-label="Verktyg för innovationsmodellen">
        <button type="button" class="btn btn-light" onmousedown="event.preventDefault()" (click)="toggleExpandView()" data-toggle="tooltip" data-placement="bottom" title="{{isFullscreen == true ? 'Stäng fullskärmsläge' : 'Öppna fullskärmsläge'}}">
          <i class="fa" [ngClass]="(isFullscreen === true) ? 'fa-compress' : 'fa-expand'"></i>
        </button>
        <div class="im-toolbar ml-2 mr-2" id="historyBar">
          <input type="date" class="rounded" id="historyCalendar" [(ngModel)]="selectedDate" max="{{getMaxDate()}}" />
        </div>
        <!--<button type="button" class="btn btn-light" onmousedown="event.preventDefault()">
          <i class="fa fa-calendar-plus fa-fw" data-toggle="tooltip" data-placement="bottom" title="Spara tillstånd"></i>
        </button>-->
        <button type="button" class="btn btn-light" onmousedown="event.preventDefault()">
          <i class="fa fa-camera fa-fw" data-toggle="tooltip" data-placement="bottom" title="Ta ögonblicksbild" (click)="makeScreenshot()"></i>
        </button>
        <div class="btn-group" role="group">
          <button id="expandBtnGroup" type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onmousedown="event.preventDefault()">
            <i class="fas fa-expand-alt fa-fw"></i>
            Expandera...
          </button>
          <div class="dropdown-menu" aria-labelledby="expandBtnGroup">
            <button class="dropdown-item" (click)="expandAll()">Expandera allt</button>
            <button class="dropdown-item" (click)="expandThemes()">Expandera teman</button>
            <button class="dropdown-item" (click)="expandActivities()">Expandera aktiviteter</button>
          </div>
        </div>
        <div class="btn-group" role="group">
          <button id="collapseBtnGroup" type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onmousedown="event.preventDefault()">
            <i class="fas fa-compress-alt fa-fw"></i>
            Kollapsa...
          </button>
          <div class="dropdown-menu" aria-labelledby="collapseBtnGroup">
            <button class="dropdown-item" (click)="collapseAll()">Kollapsa allt</button>
            <button class="dropdown-item" (click)="collapseThemes()">Kollapsa teman</button>
            <button class="dropdown-item" (click)="collapseActivities()">Kollapsa aktiviteter</button>
          </div>
        </div>
        <div class="btn-group" role="group">
          <button id="expandBtnGroup" type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onmousedown="event.preventDefault()">
            <i class="fas fa-eye-slash fa-fw"></i>
            Dölj...
          </button>
          <div class="dropdown-menu" aria-labelledby="expandBtnGroup">
            <div class="dropdown-item" onmousedown="event.preventDefault()">
              <label for="hideExcludedCheckbox">
                <input #hideExcludedCheckbox type="checkbox" class="mr-1" id="hideExcludedCheckbox" name="hideExcluded" value="hideExcluded" [checked]="hideExcluded" (change)="onHideExcludedChanged(hideExcludedCheckbox.checked)">Exkluderade aktiviteter
              </label>
            </div>
            <div class="dropdown-item">
              <label for="hideFinishedCheckbox">
                <input #hideFinishedCheckbox type="checkbox" class="mr-1" id="hideFinishedCheckbox" name="hideFinished" value="hideFinished" [checked]="hideFinished" (change)="onHideFinishedChanged(hideFinishedCheckbox.checked)">Avslutade aktiviteter
              </label>
            </div>
          </div>
        </div>
        <div class="input-group pl-2 col-3 pr-2 justify-content-center align-items-center im-toolbar" id="searchBar">
          <input type="text" class="form-control form-control-sm" placeholder="Sök...">
          <div class="input-group-append">
            <button class="btn btn-light btn-sm" type="button" id="searchButton">
              <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
        <div class="w-100 btn btn-light btn-static">
        </div>

      </div>
    </div>
  </div>
  <div class="row mr-3">
    <table #imTableView class="table ml-3 m-0" [ngClass]="{'animate': isScreenshotting === true}" style="border-collapse:collapse;border-bottom: 1px solid lightgray">

      <!-- TABLE HEADER (PHASES) -->
      <thead class="thead-dark">
        <tr>
          <th scope="col" class="im-header im-header-first border-top-0" style=" border-radius: 6px 0 0 0;border-bottom: 1px solid white; margin-bottom: -1px;">

            <!--
            <div class="dropdown w-100">
              <button class="btn thead-dark white-text p-0 m-0 btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                2021-01-28
              </button>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="#">2020-08-15</a>
                <a class="dropdown-item" href="#">2020-01-18</a>
                <a class="dropdown-item" href="#">2019-09-07</a>
              </div>
            </div>
              -->
          </th>
          <ng-container *ngFor="let phase of phases | enumToArray">
            <th scope="col" class="im-header border-top-0 im-left-border triangle" style="border-left: 1px solid white;border-bottom: 1px solid white;" data-toggle="tooltip" title="Klicka för att markera/avmarkera">{{phase | numberToPhase: phase}}</th>
          </ng-container>
        </tr>
      </thead>

      <tbody>
        <!-- THEME ROWS -->
        <ng-container *ngFor="let theme of themes; let i = index">
          <!-- MAIN ROW -->
          <tr #themeElement data-toggle="collapse" [attr.data-target]="'#collapsedRow'+i" aria-expanded="false" class="accordion-toggle parent im-theme-{{i}}" id="parent-{{i}}" title="Klicka för att expandera/kollapsa">
            <!-- FIRST COLUMN (THEME NAME) -->
            <td class="im-theme noselect align-middle">
              <span class="fa-stack fa-2x float-left im-theme-icon">
                <i class="fa fa-circle fa-stack-2x float-left im-theme-{{i}}"></i>
                <i *ngIf="theme.name == 'Teknikutveckling'" class="fa fa-cog fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Klinisk validering'" class="fa fa-hospital fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Affärsutveckling'" class="fa fa-chart-line fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Team'" class="fa fa-users fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Jämlikhet'" class="fa fa-transgender fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Hållbarhet'" class="fa fa-leaf fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Kommunikation'" class="fa fa-bullhorn fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Finansiering'" class="fa fa-dollar-sign fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'IPR'" class="fa fa-lock fa-stack-1x fa-inverse float-left"></i>
                <i *ngIf="theme.name == 'Regelverk'" class="fa fa-gavel fa-stack-1x fa-inverse float-left"></i>
              </span><span class="align-middle im-theme-text ml-2">{{theme.name}}</span>
            </td>

            <!-- PROGRESS BARS -->
            <ng-container *ngFor="let phase of phases | enumToArray; let l = index">
              <td colspan="1" class="align-middle d-none d-md-table-cell">
                <div class="progress" [style.visibility]="hasActivities(theme, phase) ? 'visible' : 'hidden'">
                  <div id="row{{i}}col{{l}}-progress" class="im-theme-{{i}}" [class]="containsOngoingActivities(theme, phase) ? 'progress-bar progress-bar-striped' : 'progress-bar'" [style.width]="getProgress(theme, phase) + '%'" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </td>
            </ng-container>
          </tr>

          <!-- SECONDARY (COLLAPSABLE) ROW -->
          <tr class="child-parent-{{i}} sticky im-theme-{{i}} exlude-from-sortable">
            <td colspan="12" class="hiddenRow">
              <div class="accordion-body collapse container-fluid pl-0 pr-0" id="collapsedRow{{i}}">
                <table class="table borderless im-inner-table im-theme-{{i}}">
                  <tbody>
                    <tr class="exlude-from-sortable">
                      <td class="col-xs-1 im-inner-col im-inner-col-first d-none d-md-table-cell">
                      </td>

                      <!-- ACTIVITES -->
                      <ng-container *ngFor="let phase of phases | enumToArray; let j = index">
                        <td class="col-xs-1 im-cell im-inner-col">
                          <div *ngFor="let activity of (activities | matchesPhaseAndTheme: phase : theme); let k = index" class="panel-group" id="accordion-r{{i}}c{{j}}-{{k}}">
                            <div class="panel panel-default" [style.display]="activity.isexcluded == true && hideExcluded == true || (activity.status | numberToStatus) == 'checked' && hideFinished == true ? 'none' : 'block'">
                              <div class="panel-heading">
                                <h3 class="panel-title">
                                  <a #activityElement class="im-checkbox collapsed im-theme-{{i}}" [class.excluded]="activity.isexcluded" id="checkbox-r{{i}}c{{j}}-{{k}}" data-toggle="collapse" [attr.data-parent]="'#accordion-r'+i+'c'+j+'-'+k" href="#collapse-r{{i}}c{{j}}-{{k}}" aria-expanded="false">
                                    <label class="vertical-nav align-items-center d-flex">
                                      <!--<input [attr.data-parent]="'#row'+i+'col'+i+'-progress'" type="checkbox" value="10">-->
                                      <input *ngIf="hasEditRights" type="checkbox" [indeterminate]="(activity.status | numberToStatus) === 'crossed'" name="input-r{{i}}c{{j}}-{{k}}" (click)="$event.stopPropagation();" (ngModelChange)="updateStatus(activity)" [ngModel]="(activity.status | numberToStatus) === 'checked'" [attr.data-parent]="'#row'+i+'col'+i+'-progress'" [disabled]="activity.isexcluded" [title]="getCheckboxTitle(activity)">
                                      <!--<input type="checkbox" [indeterminate]="activity.status === 'crossed'" name="input-r{{i}}c{{j}}-{{k}}" (click)="$event.stopPropagation()" [ngModel]="activity.status | numberToStatus === 'checked'" (ngModelChange)="checkStatus(activity)" [attr.data-parent]="'#row'+i+'col'+i+'-progress'" [disabled]="activity.isexcluded">-->
                                      <!--<input type="checkbox" [indeterminate]="activity.status == 1" name="input-r{{i}}c{{j}}-{{k}}" (click)="$event.stoppropagation()" [ngmodel]="activity.status == 2" [attr.data-parent]="'#row'+i+'col'+i+'-progress'" [disabled]="activity.isexcluded">-->
                                      {{activity.baseactivityinfo?.name}}{{activity.customactivityinfo?.name}}
                                      <span *ngIf="isBaseActivity(activity)" class="badge badge-pill float-right ml-auto align-middle im-badge-{{i}}" data-toggle="tooltip" data-placement="bottom" data-trigger="hover" data-container="body" title="Basaktvitet – kan endast redigeras av systemadministratör" [class.excluded-badge]="activity.isexcluded">B</span>
                                    </label>
                                  </a>
                                </h3>
                              </div>

                              <div id="collapse-r{{i}}c{{j}}-{{k}}" class="panel-collapse collapse in">
                                <div class="panel-body im-theme-{{i}}">
                                  <p class="mb-1"><span *ngIf="activity.deadlinedate" title="Deadline"><span class="badge badge-danger opacity-75 mr-2"><i class="fa fa-stopwatch fa-fw"></i> {{activity.deadlinedate | jsonToDate}}</span></span><span class="badge opacity-75" [ngClass]="(activity.finishdate == null) ? 'badge-info' : 'badge-success'"><span *ngIf="activity.startdate" title="Tidsåtgång"><i class="fa fa-fw" [ngClass]="(activity.finishdate == null) ? 'fa-hourglass-half' : 'fa-hourglass-end'"></i> {{ getActivityTimeLapse(activity) }} dagar</span></span></p>
                                  <div #markdownElement class="markdown-description" markdown ngPreserveWhitespaces [data]="(activity.baseactivityinfo)?(activity.baseactivityinfo?.description):(activity.customactivityinfo?.description)"></div>
                                  <!--<a class="btn p-0"><p>Visa alternativ</p></a>-->
                                  <hr class="m-0 pb-1" />
                                  <div class="row">
                                    <!-- Edit Activity Dates -->
                                    <div class="col-12">
                                      <a class="btn activity-function-btn p-0 im-theme-{{i}}" (click)="setCurrentActivityDates(activity)">
                                        <p>
                                          <i class="fa fa-calendar fa-fw"></i><span class="ml-1">Datum ({{ numberOfDates(activity) }})</span>
                                        </p>
                                      </a>
                                    </div>
                                    <button #openEditActivityDatesModalButton [hidden]="true" data-toggle="modal" data-target="#editActivityDatesModal"></button>
                                    <!-- Edit Activity Notes -->
                                    <div class="col-12">
                                      <a class="btn activity-function-btn p-0 im-theme-{{i}}" data-toggle="modal" [attr.data-target]="'#notesModal-r'+i+'c'+j+'-'+k">
                                        <p>
                                          <i class="fa fa-pen-square fa-fw"></i><span class="ml-1">Anteckningar ({{activity.notes.length}})</span>
                                        </p>
                                      </a>
                                    </div>

                                    <!-- Modal -->
                                    <div class="modal fade" [attr.id]="'notesModal-r'+i+'c'+j+'-'+k" tabindex="-1" role="dialog" [attr.aria-labelledby]="'notesModalLabel-r'+i+'c'+j+'-'+k" aria-hidden="true">
                                      <div class="modal-dialog" id="notes-modal" role="document">
                                        <div class="modal-content">
                                          <div class="modal-header">
                                            <h5 class="modal-title" id="notesModalLabel-r{{i}}c{{j}}-{{k}}">
                                              Anteckningar
                                              <br />
                                              <small>{{activity.baseactivityinfo?.name}}{{activity.customactivityinfo?.name}} i {{theme.name}}</small>
                                            </h5>
                                            <button type="button" class="closeModal mr-0" data-dismiss="modal" aria-label="Close">
                                              <span aria-hidden="true">&times;</span>
                                            </button>
                                          </div>
                                          <div class="modal-body" id="notes-modal-body">
                                            <ng-container *ngFor="let note of sortNotes(activity.notes); let m = index" class="notes">
                                              <div class="card im-theme-{{i}} mb-3">
                                                <div class="card-header p-2 container-fluid">
                                                  <div class="row align-middle">
                                                    <div class="col-7 float-left">
                                                      <h6>
                                                        <small>
                                                          <span><b class="mr-4">{{getUserName(note.userid)}}</b>{{note.timestamp | jsonToDate}}</span>
                                                        </small>
                                                      </h6>
                                                    </div>
                                                    <div class="col-5 d-flex justify-content-end">
                                                      <h6>
                                                        <small>
                                                          <!--<a *ngIf="note.userid == currentUser.id" class="btn icon-btn p-0 align-middle" data-toggle="tooltip" data-placement="bottom" title="Redigera anteckning" ng-click="editNote(activity, note)"><i class="fa fa-edit"></a>

                                                          <a *ngIf="hasRights || note.userid == currentUser.id" class="btn icon-btn p-0 align-middle" data-toggle="tooltip" data-placement="bottom" title="Ta bort anteckning" ng-click="removeNote(activity, note)"><i class="fa fa-trash-alt"></a>-->

                                                          <a *ngIf="note.userid == currentUser.id && !note.isEditable" id="note-r{{i}}c{{j}}-{{k}}-{{m}}" class="align-middle im-link-btn mr-3" role="button" title="Redigera anteckning" (click)="toggleEditNote(activity, note)">Redigera</a>

                                                          <a *ngIf="note.userid == currentUser.id && note.isEditable" class="align-middle im-link-btn mr-3" role="button" title="Spara anteckning" (click)="updateNote(activity, note)">Spara</a>

                                                          <a *ngIf="note.userid == currentUser.id && note.isEditable" class="align-middle im-link-btn mr-3" role="button" title="Avbryt redigera anteckning" (click)="resetNote(activity, note)">Avbryt</a>

                                                          <a *ngIf="!note.isEditable && hasAdminRights || note.userid == currentUser.id && !note.isEditable" role="button" class="align-middle im-link-btn" data-target="#deleteNoteModal" data-toggle="modal" (click)="setCurrentNote(note, activity)">Ta bort</a>

                                                        </small>
                                                      </h6>
                                                    </div>
                                                  </div>
                                                </div>
                                                <div class="card-body p-2">
                                                  <p *ngIf="!note.isEditable" class="card-text">{{note.text}}</p>

                                                  <textarea *ngIf="note.isEditable" type="text" style="font-size: 12px;" class="w-100" maxlength="250" [(ngModel)]="note.text" required>{{note.text}}</textarea>
                                                </div>
                                              </div>
                                            </ng-container>

                                            <p *ngIf="activity.notes.length == 0">Inga anteckningar har lagts till.</p>
                                          </div>
                                          <div class="modal-footer">

                                            <form *ngIf="hasEditRights" [formGroup]="noteForm" ngNativeValidate class="form-group mt-2 w-100" id="noteForm-r{{i}}c{{j}}-{{k}}-{{m}}" (ngSubmit)="addNote(activity)">
                                              <p class="p-0 m-0"><label for="note-text-r{{i}}c{{j}}-{{k}}-{{m}}" class="col-form-label">Ny anteckning:</label></p>
                                              <textarea class="form-control" formControlName="text" id="note-text-r{{i}}c{{j}}-{{k}}-{{m}}" maxlength="250" required></textarea>
                                              <input type="submit" class="btn btn-primary mt-2 float-right" [disabled]="!noteForm.dirty && isEditingNote" value="Lägg till" />
                                            </form>
                                            <p *ngIf="!hasEditRights" class="text-center w-100">Du har inte behörighet att lägga till anteckningar.</p>
                                          </div>
                                        </div>

                                      </div>
                                    </div>




                                    <div class="col-12">
                                      <a class="btn activity-function-btn p-0 im-theme-{{i}}" data-toggle="modal" [attr.data-target]="'#resourcesModal-r'+i+'c'+j+'-'+k">
                                        <p>
                                          <i class="fa fa-link fa-fw"></i><span class="ml-1">Länkar ({{activity.resources?.length}})</span>
                                        </p>
                                      </a>
                                    </div>

                                    <div class="modal fade" [attr.id]="'resourcesModal-r'+i+'c'+j+'-'+k" tabindex="-1" role="dialog" [attr.aria-labelledby]="'resourcesModalLabel-r'+i+'c'+j+'-'+k" aria-hidden="true">
                                      <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                          <div class="modal-header">
                                            <h5 class="modal-title" id="resourcesModalLabel-r{{i}}c{{j}}-{{k}}">
                                              Länkar
                                              <br />
                                              <small>{{activity.baseactivityinfo?.name}}{{activity.customactivityinfo?.name}} i {{theme.name}}</small>
                                            </h5>
                                            <button type="button" class="closeModal mr-0" data-dismiss="modal" aria-label="Close">
                                              <span aria-hidden="true">&times;</span>
                                            </button>
                                          </div>
                                          <div class="modal-body">
                                            <ng-container *ngFor="let resource of activity.resources; let m = index" class="resources">
                                              <ul class="list-group list-group-flush pl-0">
                                                <li class="list-group-item pt-0">
                                                  <a *ngIf="!resource.isEditable" class="button-link" style="font-size: 12px;" href="{{resource.url}}" target="_blank">
                                                    {{resource.text || resource.url}} &#8599;
                                                  </a>
                                                  <form ngNoForm *ngIf="resource.isEditable">
                                                    <p class="p-0 m-0"><label for="url-edit-r{{i}}c{{j}}-{{k}}-{{m}}" class="col-form-label">Länk:</label></p>
                                                    <input id="url-edit-r{{i}}c{{j}}-{{k}}-{{m}}" class="w-100 form-control" type="url" style="font-size: 12px;" maxlength="250" name="editURL" [(ngModel)]="resource.url" required value="{{resource.url}}" pattern="{{htmlReg}}" />

                                                    <p class="p-0 m-0"><label for="url-text-edit-r{{i}}c{{j}}-{{k}}-{{m}}" class="col-form-label">Länktext (valfritt):</label></p>
                                                    <input *ngIf="resource.isEditable" id="url-text-edit-r{{i}}c{{j}}-{{k}}-{{m}}" class="w-100 form-control mt-2 mb-3" type="url" style="font-size: 12px;" maxlength="250" name="editURLtext" [(ngModel)]="resource.text" value="{{resource.text}}" pattern="{{htmlReg}}" />

                                                    <input class="align-middle btn btn-primary btn-sm mr-3" title="Spara länk" (click)="updateResource(activity, resource)" value="Spara" type="submit">

                                                    <a *ngIf="resource.isEditable" class="align-middle btn btn-secondary btn-sm mr-3" role="button" title="Avbryt redigera länk" (click)="resetResource(activity, resource)" style="color: white;">Avbryt</a>
                                                  </form>
                                                  <br *ngIf="!resource.isEditable" />
                                                  <a *ngIf="!resource.isEditable && hasEditRights" id="note-r{{i}}c{{j}}-{{k}}-{{m}}" class="align-middle im-link-btn mr-3" role="button" title="Redigera länk" (click)="toggleEditResource(activity, resource)">Redigera</a>

                                                  <a *ngIf="!resource.isEditable && hasEditRights" role="button" class="align-middle im-link-btn" data-target="#removeResourceModal" data-toggle="modal" (click)="setCurrentResource(resource, activity)">Ta bort</a>

                                                </li>
                                              </ul>
                                              <br />
                                            </ng-container>
                                            <h6 *ngIf="activity.resources?.length == 0">
                                              <small>Länkar saknas för denna aktivitet.</small>
                                            </h6>

                                          </div>
                                          <div class="modal-footer">
                                            <form *ngIf="hasEditRights" [formGroup]="resourceForm" ngNativeValidate class="form-group mt-2 w-100" id="resourceForm-r{{i}}c{{j}}-{{k}}-{{m}}" (ngSubmit)="addResource(activity)">

                                              <p class="p-0 m-0"><label for="url-r{{i}}c{{j}}-{{k}}-{{m}}" class="col-form-label">Länk:</label></p>
                                              <input type="text" class="form-control" formControlName="url" id="url-r{{i}}c{{j}}-{{k}}-{{m}}" maxlength="250" required [ngClass]="{ 'is-invalid': submittedResource && fResources.url.errors }" placeholder="Ange en webbadress" />

                                              <div *ngIf="submittedResource && fResources.url.errors" class="invalid-feedback">
                                                <div *ngIf="fResources.url.errors.required">Ange en webbadress.</div>
                                                <div *ngIf="fResources.url.errors.pattern" style="font-size: 12px;">Ange en giltig webbadress på formen www.exemple.com.</div>
                                              </div>

                                              <p class="p-0 m-0"><label for="url-text-r{{i}}c{{j}}-{{k}}-{{m}}" class="col-form-label">Länktext (valfritt):</label></p>
                                              <input type="text" class="form-control" formControlName="text" id="url-text-r{{i}}c{{j}}-{{k}}-{{m}}" maxlength="250" [ngClass]="{ 'is-invalid': submittedResource && fResources.text.errors }" placeholder="Ange en adresstext" />
                                              <!--<div *ngIf="submittedResource && fResources.text.errors" class="invalid-feedback">
                                                <div *ngIf="fResources.url.errors.required">Ange en webbadress.</div>
                                                <div *ngIf="fResources.url.errors.pattern" style="font-size: 12px;">Ange en giltig webbadress på formen www.exemple.com.</div>


                                              </div>-->
                                              <input type="submit" class="btn btn-primary mt-2 float-right" [disabled]="!resourceForm.dirty || isEditingResource" value="Lägg till" />
                                            </form>
                                            <p *ngIf="!hasEditRights" class="text-center w-100">Du har inte behörighet att lägga till länkar.</p>
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                                    <div *ngIf="hasEditRights" class="col-12">
                                      <a class="btn activity-function-btn p-0 im-theme-{{i}}" (click)="toggleActivityIsExcluded(activity)">
                                        <p>
                                          <i class="fa fa-fw" [ngClass]="(activity.isexcluded == true) ? 'fa-check-circle' : 'fa-times-circle'"></i><span class="ml-1">{{ activity.isexcluded == true ? 'Inkludera' : 'Exkludera' }}</span>
                                        </p>
                                      </a>
                                    </div>

                                    <div class="col-12">
                                      <a *ngIf="!isBaseActivity(activity)" class="btn activity-function-btn p-0 im-theme-{{i}}" (click)="setCurrentActivityInfo(activity)">
                                        <p>
                                          <i class="fa fa-edit fa-fw"></i><span class="ml-1">Redigera</span>
                                        </p>
                                      </a>
                                    </div>
                                    <button #openEditActivityModalButton [hidden]="true" data-toggle="modal" data-target="#editActivityModal"></button>

                                  </div>

                                </div>
                              </div>
                            </div>
                          </div>
                          <div *ngIf="hasEditRights" class="row mt-1 ml-1">
                            <button class="btn p-1 text-left activity-add-btn im-theme-add-btn-{{i}}" data-toggle="modal" [attr.data-target]="'#addActivityModal'" (click)="setCurrentThemeAndPhase(theme, phase)"><h6><small><span><i class="fa fa-plus"></i> Skapa ny aktivitet</span></small></h6></button>
                          </div>
                        </td>
                      </ng-container>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
        </ng-container>
      </tbody>
    </table>
    <div class="row ml-3 mt-4">
      <alert></alert>
    </div>
  </div>


  <div class="modal" id="markdownInfoModal" tabindex="-1" role="dialog" aria-labelledby="markdownInfoModalLabel" aria-hidden="true" data-backdrop="false" style="z-index: 1500 !important;">
    <div class="modal-dialog" style="top: 10%; left:10%;" role="dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Formateringshjälp
          </h5>
          <button type="button" class="close mr-0" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>
            Medtech Innovation Model använder Markdown för att formatera text. Se den kompletta syntaxen <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">här</a>.
          </p>
          <table class="table table-markdown">
            <thead>
              <tr>
                <th scope="col">Formatering</th>
                <th scope="col">Markdown syntax</th>
                <!--<th scope="col">Resultat</th>-->

              </tr>
            </thead>
            <tbody>
              <tr>
                <!--<td>Fet text</td>-->
                <td><b>Fet text</b></td>
                <td>**Fet text**</td>

              </tr>
              <tr>
                <!--<td>Kursiv text</td>-->
                <td><i>Kursiv text</i></td>
                <td>*Kursiv text* eller _Kursiv text_</td>
              </tr>
              <tr>
                <!--<td>Understruken text</td>-->
                <td><u>Genomstrukten text</u></td>
                <td>~~Genomstrukten text~~</td>
              </tr>
              <tr>
                <!--<td>Länk</td>-->
                <td><a href="" onclick="return false">Länk</a></td>
                <td>[Länk] eller http://www.exempel.com</td>
              </tr>
              <tr>
                <!--<td>Punktlista</td>-->
                <td><ul style="font-size: 14px;"><li>Första</li><li>Andra</li><li>Tredje</li></ul></td>
                <td>* Första<br />* Andra<br />* Tredje</td>

              </tr>
              <!--<tr>
                <td>Horisontell linje</td>
                <td>---</td>
                <td><hr /></td>
              </tr>-->
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <div class="modal" id="deleteNoteModal" tabindex="-1" role="dialog" aria-labelledby="deleteNoteModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-sm" style="top: 10%" role="dialog">
      <div class="modal-content">
        <!--<div class="modal-header">
          <h5 class="modal-title">
            Nollställ projekt
          </h5>
          <button type="button" class="close mr-0" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>-->
        <div class="modal-body">
          <h6 class="text-wrap">
            Är du säker på att du vill ta bort anteckningen?
          </h6>
          <p>Anteckningen kommer tas bort permanent. Åtgärden går inte att ångra.</p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">Nej, avbryt</button>
          <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" (click)="removeNote()">Ja, ta bort</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="removeResourceModal" tabindex="-1" role="dialog" aria-labelledby="removeResourceModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-sm" style="top: 10%" role="dialog">
      <div class="modal-content">
        <!--<div class="modal-header">
          <h5 class="modal-title">
            Nollställ projekt
          </h5>
          <button type="button" class="close mr-0" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>-->
        <div class="modal-body">
          <h6 class="text-wrap">
            Är du säker på att du vill ta bort länken?
          </h6>
          <p>Länken kommer tas bort permanent. Åtgärden går inte att ångra.</p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">Nej, avbryt</button>
          <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" (click)="removeResource()">Ja, ta bort</button>
        </div>
      </div>
    </div>
  </div>

  <form [formGroup]="activityInfoForm" (ngSubmit)="addActivity()">
    <div class="modal fade" id="addActivityModal" tabindex="-1" role="dialog" aria-labelledby="addActivityModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="top: 10%" role="dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Skapa ny aktivitet
              <br />
              <small>i {{currentTheme?.name}} under {{currentPhase | numberToPhase}}</small>
            </h5>
            <button #closeAddActivityModal type="button" class="close mr-0" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div *ngIf="currentUser.userrole?.includes('AdminUser')" class="form-group">
              <div class="form-check">
                <input formControlName="type" class="form-check-input from-control" type="radio" name="flexRadioDefault" id="flexRadioDefault1" [value]="true" checked>
                <label class="form-check-label" for="flexRadioDefault1">
                  Basktivititet (visas för alla projekt)
                </label>
              </div>
              <div class="form-check">
                <input formControlName="type" class="form-check-input form-control" type="radio" name="flexRadioDefault" id="flexRadioDefault2" [value]="false">
                <label class="form-check-label" for="flexRadioDefault2">
                  Egen aktivitet (visas endast för aktuellt projekt)
                </label>
              </div>
              <small>...</small>
            </div>
            <div class="form-group">
              <label for="activityName">Namn</label>
              <input id="activityName" type="text" formControlName="name" class="form-control" [ngClass]="{ 'is-invalid': submittedActivity && f.name.errors }" />
              <div *ngIf="submitted && f.name.errors" class="invalid-feedback">
                <div *ngIf="f.name.errors.required">Namn är obligatoriskt</div>
              </div>
            </div>
            <div class="form-group">
              <label for="activityDescription">Beskrivning</label>
              <textarea id="activityDescription" type="text" formControlName="description" class="form-control" [ngClass]="{ 'is-invalid': submittedActivity && f.description.errors }"></textarea>
              <div *ngIf="submitted && f.description.errors" class="invalid-feedback">
                <div *ngIf="f.description.errors.required">Beskrivning är obligatoriskt</div>
              </div>
              <button type="button" class="btn btn-light float-right mt-2" data-target="#markdownInfoModal" data-toggle="modal">Formateringshjälp</button>
            </div>
          </div>
          <div class="modal-footer">
            <div class="form-group">
              <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Avbryt</button>
              <button type="submit" [disabled]="!activityInfoForm.valid" class="btn btn-primary btn-sm">Spara</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <form [formGroup]="editActivityInfoForm" (ngSubmit)="editActivity()">
    <div class="modal fade" id="editActivityModal" tabindex="-1" role="dialog" [attr.aria-labelledby]="editActivityInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="top: 10%" role="dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Redigera aktivitet
              <br />
              <small>{{currentActivityInfo?.name}} i {{currentActivityInfo?.theme?.name}}</small>
            </h5>
            <button #closeEditActivityModal type="button" class="close mr-0" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div *ngIf="currentUser.userrole?.includes('AdminUser')" class="form-group">
              <div class="form-check">
                <input formControlName="type" class="form-check-input from-control" type="radio" name="flexRadioDefault" id="flexRadioDefault1" [value]="true" checked>
                <label class="form-check-label" for="flexRadioDefault1">
                  Basktivititet (visas för alla projekt)
                </label>
              </div>
              <div class="form-check">
                <input formControlName="type" class="form-check-input form-control" type="radio" name="flexRadioDefault" id="flexRadioDefault2" [value]="false">
                <label class="form-check-label" for="flexRadioDefault2">
                  Egen aktivitet (visas endast för aktuellt projekt)
                </label>
              </div>
              <small>...</small>
            </div>
            <div class="form-group">
              <label for="name">Namn</label>
              <input type="text" formControlName="name" class="form-control" [ngClass]="{ 'is-invalid': submittedActivity && fEdit.name.errors }" [value]="currentActivityInfo?.name" />
              <div *ngIf="submitted && fEdit.name.errors" class="invalid-feedback">
                <div *ngIf="fEdit.name.errors.required">Namn är obligatoriskt</div>
              </div>
            </div>
            <div class="form-group">
              <label for="description">Beskrivning</label>
              <textarea type="text" formControlName="description" class="form-control" [ngClass]="{ 'is-invalid': submittedActivity && fEdit.description.errors }" [value]="currentActivityInfo?.description"></textarea>
              <div *ngIf="submitted && fEdit.description.errors" class="invalid-feedback">
                <div *ngIf="fEdit.description.errors.required">Beskrivning är obligatoriskt</div>
              </div>
              <button type="button" class="btn btn-light float-right mt-2" data-target="#markdownInfoModal" data-toggle="modal">Formateringshjälp</button>
            </div>
            <div class="form-group">
              <label [attr.for]="'theme-sel-r'+i+'c'+j+'-'+k" class="mt-3">Tema</label>
              <select [attr.id]="'theme-sel-r'+i+'c'+j+'-'+k" class="form-control" formControlName="theme">
                <option *ngFor="let optionTheme of themes" [ngValue]="optionTheme" [selected]="optionTheme.themeid === currentActivityInfo?.theme?.themeid">{{optionTheme.name}}</option>
              </select>
            </div>
            <div class="form-group">
              <label [attr.for]="'phase-sel-r'+i+'c'+j+'-'+k">Fas</label>
              <select [attr.id]="'phase-sel-r'+i+'c'+j+'-'+k" class="form-control" formControlName="phase">
                <option *ngFor="let optionPhase of phases | enumToArray; let idx = index" [ngValue]="optionPhase" [selected]="optionPhase === currentActivityInfo?.phase">{{idx+1}}. {{optionPhase | numberToPhase}}</option>
              </select>
            </div>
            <!--<div *ngIf="!isBaseActivity(activity)" class="form-group m-0">
              <label [attr.for]="'theme-sel-r'+i+'c'+j+'-'+k">Tema</label>
              <select [attr.id]="'theme-sel-r'+i+'c'+j+'-'+k" class="form-control" formControlName="theme">
                <option *ngFor="let currentTheme of themes" [ngValue]="currentTheme" [selected]="isCurrentTheme(currentTheme, activity)">{{theme.name}}</option>
              </select>
            </div>-->
          </div>
          <div class="modal-footer">
            <div class="form-group">
              <button type="button" class="btn btn-danger btn-sm mr-1 float-left" data-target="#deleteActivityModal" data-toggle="modal">Ta bort</button>
              <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Avbryt</button>
              <button type="submit" [disabled]="!editActivityInfoForm.valid || !editActivityInfoForm.dirty" class="btn btn-primary btn-sm">Spara</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>


  <div class="modal" id="deleteActivityModal" tabindex="-1" role="dialog" aria-labelledby="deleteActivityModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-sm" style="top: 10%" role="dialog">
      <div class="modal-content">
        <!--<div class="modal-header">
          <h5 class="modal-title">
            Nollställ projekt
          </h5>
          <button type="button" class="close mr-0" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>-->
        <div class="modal-body">
          <h6 class="text-wrap">
            Är du säker på att du vill ta bort aktiviteten?
          </h6>
          <p>Aktiviteten kommer tas bort permanent. Åtgärden går inte att ångra.</p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">Nej, avbryt</button>
          <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" (click)="deleteActivity(currentActivity.activityid, currentActivityInfo.customactivityinfoid || currentActivityInfo.baseactivityid, currentActivityInfo.hasOwnProperty('baseactivityid'));">Ja, ta bort</button>
        </div>
      </div>
    </div>
  </div>

  <!---->
  <form [formGroup]="editActivityDatesForm" (ngSubmit)="editActivityDates()">
    <div class="modal fade" id="editActivityDatesModal" tabindex="-1" role="dialog" [attr.aria-labelledby]="editActivityDatesModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="top: 10%" role="dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Datum
              <br />
              <small>för {{currentActivityInfo?.name}} i {{currentActivityInfo?.theme?.name}}</small>
            </h5>
            <button #closeEditActivityDatesModal type="button" class="close mr-0" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="activityDeadlineDate">Deadline</label>
              <input id="activityDeadlineDate" formControlName="deadline" *ngIf="hasEditRights" class="form-control rounded" type="date" [value]="currentActivity?.deadlinedate?.split('T')[0]" />
              <p *ngIf="!hasEditRights && currentActivity?.deadlinedate"> {{currentActivity?.deadlinedate?.split('T')[0]}} </p>
              <p *ngIf="!hasEditRights && !currentActivity?.deadlinedate"> Inget datum satt </p>
            </div>
            <div class="form-group">
              <label for="activityStartedDate">Påbörjad</label>
              <input id="activityStartedDate" formControlName="started" *ngIf="hasEditRights" class="form-control rounded" [max]="getMaxStartedDate()" type="date" [value]="currentActivity?.startdate?.split('T')[0]" />
              <p *ngIf="!hasEditRights && currentActivity?.startdate"> {{currentActivity?.startdate?.split('T')[0]}} </p>
              <p *ngIf="!hasEditRights && !currentActivity?.startdate"> Inget datum satt </p>
            </div>
            <div class="form-group">
              <label for="activityFinishedDate">Avslutad</label>
              <input id="activityFinishedDate" formControlName="finished" *ngIf="hasEditRights" class="form-control rounded" [min]="getMinFinishedDate()" type="date" [value]="currentActivity?.finishdate?.split('T')[0]" />
              <p *ngIf="!hasEditRights && currentActivity?.finishdate"> {{currentActivity?.finishdate?.split('T')[0]}} </p>
              <p *ngIf="!hasEditRights && !currentActivity?.finishdate"> Inget datum satt </p>
            </div>
            <div class="modal-footer">
              <div class="form-group">
                <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Avbryt</button>
                <button type="submit" class="btn btn-primary btn-sm" [disabled]="isActivityDatesClean()" *ngIf="hasEditRights">Spara</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
  <!---->

  <div id="download">
    <img style="background: red" #canvas>
    <a style="background: red" #downloadLink></a>
  </div>
</div>
